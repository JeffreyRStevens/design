<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>6 Avoid hidden arguments | Tidyverse design guide</title>
<meta name="author" content="Tidyverse team">
<meta name="generator" content="bookdown 0.29 with bs4_book()">
<meta property="og:title" content="6 Avoid hidden arguments | Tidyverse design guide">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="6 Avoid hidden arguments | Tidyverse design guide">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-115082821-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<meta name="description" content="6.1 What’s the problem? Functions are easier to understand if the results depend only on the values of the inputs. If a function returns surprisingly different results with the same inputs, then...">
<meta property="og:description" content="6.1 What’s the problem? Functions are easier to understand if the results depend only on the values of the inputs. If a function returns surprisingly different results with the same inputs, then...">
<meta name="twitter:description" content="6.1 What’s the problem? Functions are easier to understand if the results depend only on the values of the inputs. If a function returns surprisingly different results with the same inputs, then...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Tidyverse design guide</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="structure.html"><span class="header-section-number">1</span> Structure</a></li>
<li><a class="" href="unifying-principles.html"><span class="header-section-number">2</span> Unifying principles</a></li>
<li class="book-part">Implementation</li>
<li><a class="" href="names-attribute.html"><span class="header-section-number">3</span> Names attribute</a></li>
<li><a class="" href="call-data-details.html"><span class="header-section-number">4</span> Name details arguments</a></li>
<li><a class="" href="function-names.html"><span class="header-section-number">5</span> Function names</a></li>
<li class="book-part">Interface: inputs</li>
<li><a class="active" href="args-hidden.html"><span class="header-section-number">6</span> Avoid hidden arguments</a></li>
<li><a class="" href="args-data-details.html"><span class="header-section-number">7</span> Data, descriptors, details</a></li>
<li><a class="" href="args-independence.html"><span class="header-section-number">8</span> Avoid dependencies between arguments</a></li>
<li><a class="" href="case-study-setnames.html"><span class="header-section-number">9</span> Case study: setNames()</a></li>
<li class="book-part">Interface: default values</li>
<li><a class="" href="def-required.html"><span class="header-section-number">10</span> Required args shouldn’t have defaults</a></li>
<li><a class="" href="cs-rep.html"><span class="header-section-number">11</span> Case study: rep()</a></li>
<li><a class="" href="def-enum.html"><span class="header-section-number">12</span> Enumerate possible options</a></li>
<li><a class="" href="def-magical.html"><span class="header-section-number">13</span> Avoid magical defaults</a></li>
<li><a class="" href="def-short.html"><span class="header-section-number">14</span> Keep defaults short and sweet</a></li>
<li><a class="" href="def-inform.html"><span class="header-section-number">15</span> Explain important defaults</a></li>
<li><a class="" href="def-user.html"><span class="header-section-number">16</span> User settable defaults</a></li>
<li><a class="" href="cs-rgb.html"><span class="header-section-number">17</span> Case study: rgb()</a></li>
<li class="book-part">Interface: ...</li>
<li><a class="" href="dots-position.html"><span class="header-section-number">18</span> Data, dots, details</a></li>
<li><a class="" href="dots-data.html"><span class="header-section-number">19</span> Making data with …</a></li>
<li><a class="" href="dots-prefix.html"><span class="header-section-number">20</span> Dot prefix</a></li>
<li><a class="" href="dots-inspect.html"><span class="header-section-number">21</span> Inspect the dots</a></li>
<li><a class="" href="cs-mapply-pmap.html"><span class="header-section-number">22</span> Case study: mapply() vs pmap()</a></li>
<li class="book-part">Interface: outputs</li>
<li><a class="" href="out-multi.html"><span class="header-section-number">23</span> Returning multiple values</a></li>
<li><a class="" href="out-type-stability.html"><span class="header-section-number">24</span> Type-stability</a></li>
<li><a class="" href="out-vectorisation.html"><span class="header-section-number">25</span> Vectorisation</a></li>
<li><a class="" href="out-invisible.html"><span class="header-section-number">26</span> Side-effect functions should return invisibly</a></li>
<li class="book-part">Interface: errors</li>
<li><a class="" href="err-call.html"><span class="header-section-number">27</span> Error call</a></li>
<li><a class="" href="err-constructor.html"><span class="header-section-number">28</span> Error constructors</a></li>
<li class="book-part">Interface: changes</li>
<li><a class="" href="changes-multivers.html"><span class="header-section-number">29</span> Work with multiple dependency versions</a></li>
<li class="book-part">Interface: side effects</li>
<li><a class="" href="side-effect-soup.html"><span class="header-section-number">30</span> Side-effect soup</a></li>
<li><a class="" href="spooky-action.html"><span class="header-section-number">31</span> Spooky action</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="glossary.html"><span class="header-section-number">A</span> Glossary</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="http://github.com/tidyverse/design">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="args-hidden" class="section level1" number="6">
<h1>
<span class="header-section-number">6</span> Avoid hidden arguments<a class="anchor" aria-label="anchor" href="#args-hidden"><i class="fas fa-link"></i></a>
</h1>
<div id="whats-the-problem" class="section level2" number="6.1">
<h2>
<span class="header-section-number">6.1</span> What’s the problem?<a class="anchor" aria-label="anchor" href="#whats-the-problem"><i class="fas fa-link"></i></a>
</h2>
<p>Functions are easier to understand if the results depend only on the values of the inputs. If a function returns surprisingly different results with the same inputs, then we say it has <strong>hidden arguments</strong>. Hidden arguments make code harder to reason about, because to correctly predict the output you also need to know some other state.</p>
<p>Related:</p>
<ul>
<li>This pattern is about surprising inputs; <a href="spooky-action.html#spooky-action">Spooky action</a> is about
suprising outputs.</li>
</ul>
</div>
<div id="what-are-some-examples" class="section level2" number="6.2">
<h2>
<span class="header-section-number">6.2</span> What are some examples?<a class="anchor" aria-label="anchor" href="#what-are-some-examples"><i class="fas fa-link"></i></a>
</h2>
<p>One common source of hidden arguments is the use of global options. These can be useful to control display but, as discussed in Chapter <a href="def-user.html#def-user">16</a>), should not affect computation:</p>
<ul>
<li><p>The result of <code>data.frame(x = "a")$x</code> depends on the value of the global
<code>stringsAsFactors</code> option: if it’s <code>TRUE</code> (the default) you get a factor;
if it’s false, you get a character vector.</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>’s handling of missing values depends on the global option of
<code>na.action</code>. The default is <code>na.omit</code> which drops the missing values
prior to fitting the model (which is inconvenient because then the results
of <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> don’t line up with the input data. <code><a href="https://modelr.tidyverse.org/reference/na.warn.html">modelr::na.warn()</a></code>
provides an approach more in line with other base behaviours: it drops
missing values with a warning.)</p></li>
</ul>
<p>Another common source of hidden inputs is the system locale:</p>
<ul>
<li><p><code><a href="https://rdrr.io/r/base/strptime.html">strptime()</a></code> relies on the names of weekdays and months in the current
locale. That means <code>strptime("1 Jan 2020", "%d %b %Y")</code> will work on
computers with an English locale, and fail elsewhere. This is particularly
troublesome for Europeans who frequently have colleagues who speak a
different language.</p></li>
<li>
<p><code><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct()</a></code> depends on the current timezone. The following code returns
different underlying times when run on different computers:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2020-01-01 09:00"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2020-01-01 09:00:00 UTC"</span></span></code></pre></div>
</li>
<li>
<p><code><a href="https://rdrr.io/r/base/chartr.html">toupper()</a></code> and <code><a href="https://rdrr.io/r/base/chartr.html">tolower()</a></code> depend on the current locale. It is faily
uncommon for this to cause problems because most languages either
use their own character set, or use the same rules for capitalisation as
English. However, this behaviour did cause a bug in ggplot2 because
internally it takes <code>geom = "identity"</code> and turns it into <code>GeomIdentity</code>
to find the object that actually does computation. In Turkish, however, the
upper case version of i is İ, and <code>Geomİdentity</code> does not exist. This
meant that for some time ggplot2 did not work on Turkish computers.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org">stringr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper</a></span><span class="op">(</span><span class="st">"i"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "I"</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper</a></span><span class="op">(</span><span class="st">"i"</span>, locale <span class="op">=</span> <span class="st">"tr"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "İ"</span></span></code></pre></div>
</li>
<li><p>For similar reasons, <code><a href="https://rdrr.io/r/base/sort.html">sort()</a></code> and <code><a href="https://rdrr.io/r/base/order.html">order()</a></code> rely on the lexicographic
order defined by the current locale. <code><a href="https://rdrr.io/r/base/factor.html">factor()</a></code> uses <code><a href="https://rdrr.io/r/base/order.html">order()</a></code>, so the
results from factor depend implicitly on the current locale. (This is
not an imaginary problem as this
<a href="https://stackoverflow.com/questions/39339489">SO question</a>) attests).</p></li>
</ul>
<p>Some functions depend on external settings, but not in a surprising way:</p>
<ul>
<li><p><code><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time()</a></code> depends on the system time, but it’s not a surprise: getting
the current time is to the whole point of the function!</p></li>
<li><p><code>read.csv(path)</code> depends not on the value of <code>path</code> but the contents of the
file at that location. Reading from the file system necessarily implies that
the results depend on the contents of the file, not its path, so this is not
a surprise.</p></li>
<li><p>Random number generators like <code><a href="https://rdrr.io/r/stats/Uniform.html">runif()</a></code> peek at the value of the special
global variable <code>.Random.seed</code>. This is a little surprising, but if they
didn’t have some global state every call to <code><a href="https://rdrr.io/r/stats/Uniform.html">runif()</a></code> would return the
same value.</p></li>
</ul>
</div>
<div id="why-is-it-important" class="section level2" number="6.3">
<h2>
<span class="header-section-number">6.3</span> Why is it important?<a class="anchor" aria-label="anchor" href="#why-is-it-important"><i class="fas fa-link"></i></a>
</h2>
<p>Hidden arguments are bad because they make it much harder to predict the output of a fuction. The worst offender by far is the <code>stringsAsFactors</code> option which changes how a number of functions (including <code><a href="https://rdrr.io/r/base/data.frame.html">data.frame()</a></code>, <code><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame()</a></code>, and <code><a href="https://rdrr.io/r/utils/read.table.html">read.csv()</a></code>) treat character vectors. This exists mostly for historical reasons, as described in <a href="http://simplystatistics.org/2015/07/24/stringsasfactors-an-unauthorized-biography/"><em>stringsAsFactors: An unauthorized biography</em></a> by Roger Peng and <a href="http://notstatschat.tumblr.com/post/124987394001/stringsasfactors-sigh"><em>stringsAsFactors = &lt;sigh&gt;</em></a>
by Thomas Lumley. )</p>
<p>Allowing the system locale to affect the result of a function is a subtle source of bugs when sharing code between people who work in different countries. To be clear, these defaults on rarely cause problems because most languages that share the same writing system share (most of) the same collation rules. The main exceptions tend to be European languages which have varying rules for modified letters, e.g. in Norwegian, å comes at the end of the alphabet. However, when they do cause problems they will take a long time to track down: you’re unlikely to expect that the coefficients of a linear model are different<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;You’ll get different coefficients for a categorical predictor if the ordering means that a different levels comes first in the alphabet. The predictions and other diagnostics won’t be affected, but you’re likely to be surprised that your coefficients are different.&lt;/p&gt;"><sup>2</sup></a> because your code is run in a different country!</p>
</div>
<div id="how-can-i-remediate-the-problem" class="section level2" number="6.4">
<h2>
<span class="header-section-number">6.4</span> How can I remediate the problem?<a class="anchor" aria-label="anchor" href="#how-can-i-remediate-the-problem"><i class="fas fa-link"></i></a>
</h2>
<p>Generally, hidden arguments are easy to avoid when creating new functions: simply avoid depending on environment variables (like the locale), or global options (like <code>stringsAsFactors</code>). The easiest way for problems to creep in is for you to not realise a function has hidden inputs; make sure to consult the list of common offenders provided above.</p>
<p>If you must depend on an environment variable or option, make sure it’s an explicit argument, as in Chapter <a href="def-user.html#def-user">16</a>. Such arguments generally should not affect computation (only side-effects like printed output or status messages); if they do affect results, follow Chapter <a href="def-inform.html#def-inform">15</a> to make sure to inform the user what’s happening.</p>
<p>If you have an existing function with a hidden input, you’ll need to take both steps above. First make sure the input is an explicit option, and then make sure it’s printed. For example, lets take <code><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct()</a></code> which basically looks something like this:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">as.POSIXct</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">tz</span> <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">x</span>, tz <span class="op">=</span> <span class="va">tz</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2020-01-01 09:00"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2020-01-01 09:00:00 UTC"</span></span></code></pre></div>
<p>The <code>tz</code> argument is present, but it’s not obvious that <code>""</code> means take from the system timezone. Let’s first make that explicit:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">as.POSIXct</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">tz</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/timezones.html">Sys.timezone</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">x</span>, tz <span class="op">=</span> <span class="va">tz</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2020-01-01 09:00"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2020-01-01 09:00:00 UTC"</span></span></code></pre></div>
<p>This is an important argument coming (indirectly) from an environment variable, so we should also print it out if the user hasn’t explicitly set it:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">as.POSIXct</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">tz</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/timezones.html">Sys.timezone</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span><span class="op">(</span><span class="va">tz</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Using `tz = '"</span>, <span class="va">tz</span>, <span class="st">"'`"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">x</span>, tz <span class="op">=</span> <span class="va">tz</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="st">"2020-01-01 09:00"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Using `tz = 'UTC'`</span></span>
<span><span class="co">#&gt; [1] "2020-01-01 09:00:00 UTC"</span></span></code></pre></div>

</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="function-names.html"><span class="header-section-number">5</span> Function names</a></div>
<div class="next"><a href="args-data-details.html"><span class="header-section-number">7</span> Data, descriptors, details</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#args-hidden"><span class="header-section-number">6</span> Avoid hidden arguments</a></li>
<li><a class="nav-link" href="#whats-the-problem"><span class="header-section-number">6.1</span> What’s the problem?</a></li>
<li><a class="nav-link" href="#what-are-some-examples"><span class="header-section-number">6.2</span> What are some examples?</a></li>
<li><a class="nav-link" href="#why-is-it-important"><span class="header-section-number">6.3</span> Why is it important?</a></li>
<li><a class="nav-link" href="#how-can-i-remediate-the-problem"><span class="header-section-number">6.4</span> How can I remediate the problem?</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="http://github.com/tidyverse/design/blob/main/args-hidden.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="http://github.com/tidyverse/design/edit/main/args-hidden.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Tidyverse design guide</strong>" was written by Tidyverse team. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
