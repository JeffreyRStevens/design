<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>31 Spooky action | Tidyverse design guide</title>
<meta name="author" content="Tidyverse team">
<meta name="generator" content="bookdown 0.29 with bs4_book()">
<meta property="og:title" content="31 Spooky action | Tidyverse design guide">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="31 Spooky action | Tidyverse design guide">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-115082821-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<meta name="description" content='31.1 What’s the problem? There are no limits to what an function or script can do. After you call draw_plot() or source("analyse-data.R"), you could discover that all the variables in your global...'>
<meta property="og:description" content='31.1 What’s the problem? There are no limits to what an function or script can do. After you call draw_plot() or source("analyse-data.R"), you could discover that all the variables in your global...'>
<meta name="twitter:description" content='31.1 What’s the problem? There are no limits to what an function or script can do. After you call draw_plot() or source("analyse-data.R"), you could discover that all the variables in your global...'>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Tidyverse design guide</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="structure.html"><span class="header-section-number">1</span> Structure</a></li>
<li><a class="" href="unifying-principles.html"><span class="header-section-number">2</span> Unifying principles</a></li>
<li class="book-part">Implementation</li>
<li><a class="" href="names-attribute.html"><span class="header-section-number">3</span> Names attribute</a></li>
<li><a class="" href="call-data-details.html"><span class="header-section-number">4</span> Name details arguments</a></li>
<li><a class="" href="function-names.html"><span class="header-section-number">5</span> Function names</a></li>
<li class="book-part">Interface: inputs</li>
<li><a class="" href="args-hidden.html"><span class="header-section-number">6</span> Avoid hidden arguments</a></li>
<li><a class="" href="args-data-details.html"><span class="header-section-number">7</span> Data, descriptors, details</a></li>
<li><a class="" href="args-independence.html"><span class="header-section-number">8</span> Avoid dependencies between arguments</a></li>
<li><a class="" href="case-study-setnames.html"><span class="header-section-number">9</span> Case study: setNames()</a></li>
<li class="book-part">Interface: default values</li>
<li><a class="" href="def-required.html"><span class="header-section-number">10</span> Required args shouldn’t have defaults</a></li>
<li><a class="" href="cs-rep.html"><span class="header-section-number">11</span> Case study: rep()</a></li>
<li><a class="" href="def-enum.html"><span class="header-section-number">12</span> Enumerate possible options</a></li>
<li><a class="" href="def-magical.html"><span class="header-section-number">13</span> Avoid magical defaults</a></li>
<li><a class="" href="def-short.html"><span class="header-section-number">14</span> Keep defaults short and sweet</a></li>
<li><a class="" href="def-inform.html"><span class="header-section-number">15</span> Explain important defaults</a></li>
<li><a class="" href="def-user.html"><span class="header-section-number">16</span> User settable defaults</a></li>
<li><a class="" href="cs-rgb.html"><span class="header-section-number">17</span> Case study: rgb()</a></li>
<li class="book-part">Interface: ...</li>
<li><a class="" href="dots-position.html"><span class="header-section-number">18</span> Data, dots, details</a></li>
<li><a class="" href="dots-data.html"><span class="header-section-number">19</span> Making data with …</a></li>
<li><a class="" href="dots-prefix.html"><span class="header-section-number">20</span> Dot prefix</a></li>
<li><a class="" href="dots-inspect.html"><span class="header-section-number">21</span> Inspect the dots</a></li>
<li><a class="" href="cs-mapply-pmap.html"><span class="header-section-number">22</span> Case study: mapply() vs pmap()</a></li>
<li class="book-part">Interface: outputs</li>
<li><a class="" href="out-multi.html"><span class="header-section-number">23</span> Returning multiple values</a></li>
<li><a class="" href="out-type-stability.html"><span class="header-section-number">24</span> Type-stability</a></li>
<li><a class="" href="out-vectorisation.html"><span class="header-section-number">25</span> Vectorisation</a></li>
<li><a class="" href="out-invisible.html"><span class="header-section-number">26</span> Side-effect functions should return invisibly</a></li>
<li class="book-part">Interface: errors</li>
<li><a class="" href="err-call.html"><span class="header-section-number">27</span> Error call</a></li>
<li><a class="" href="err-constructor.html"><span class="header-section-number">28</span> Error constructors</a></li>
<li class="book-part">Interface: changes</li>
<li><a class="" href="changes-multivers.html"><span class="header-section-number">29</span> Work with multiple dependency versions</a></li>
<li class="book-part">Interface: side effects</li>
<li><a class="" href="side-effect-soup.html"><span class="header-section-number">30</span> Side-effect soup</a></li>
<li><a class="active" href="spooky-action.html"><span class="header-section-number">31</span> Spooky action</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="glossary.html"><span class="header-section-number">A</span> Glossary</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="http://github.com/tidyverse/design">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="spooky-action" class="section level1" number="31">
<h1>
<span class="header-section-number">31</span> Spooky action<a class="anchor" aria-label="anchor" href="#spooky-action"><i class="fas fa-link"></i></a>
</h1>
<div id="whats-the-problem-5" class="section level2" number="31.1">
<h2>
<span class="header-section-number">31.1</span> What’s the problem?<a class="anchor" aria-label="anchor" href="#whats-the-problem-5"><i class="fas fa-link"></i></a>
</h2>
<p>There are no limits to what an function or script can do. After you call <code>draw_plot()</code> or <code>source("analyse-data.R")</code>, you <em>could</em> discover that all the variables in your global environment have been deleted, or that 1000 new files have been created on your desktop. But these actions would be surprising, because generally you expect the impact of a function (or script) to be as limited as possible. Collectively, we call such side-effects “spooky actions” because the connection between action (calling a function or sourcing a script) and result (deleting objects or upgrading packages) is surprising. It’s like flipping a light-switch and discovering that the shower starts running, or having a poltergeist that rearranges the contents of your kitchen cupboards when you’re not looking.</p>
<p>Deleting variables and creating files on your desktop are obviously surprising even if you’ve only just started using R. But there are other actions that are less obviously destructive, and only start to become surprising as your mental model of R matures. These include actions like:</p>
<ul>
<li><p><strong>Attaching packages with <code><a href="https://rdrr.io/r/base/library.html">library()</a></code></strong>. For example, <code><a href="https://ggplot2.tidyverse.org/reference/geom_map.html">ggplot2::geom_map()</a></code> used
to call <code><a href="https://rdrr.io/r/base/library.html">library(maps)</a></code> in order to make map data available to the function.
This seems harmless, but if you were using purrr, it would break <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>
<code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> would now refer to <code>maps::map()</code> rather than <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map()</a></code>.
Because of functions in different packages can have the same name, attaching
a package can change the behaviour of existing code.</p></li>
<li><p><strong>Installing packages with <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code></strong>. If a script needs dplyr to
work, and it’s not installed, it seem polite to install it on behalf of the
user. But installing a new package can upgrade existing packages, which might
break code in other projects. Install a package is a potentially destructive
operation which should be done with care.</p></li>
<li><p><strong>Deleting objects in the global environment with <code>rm(list = ls())</code></strong>.
This might seem like a good way to reset the environment so that your
script can run cleanly. But if someone else <code><a href="https://rdrr.io/r/base/source.html">source()</a></code>s your script, it will
delete objects that might be important to them. (Of course, you’d hope that
all of those objects could easily be recreated from another script, but that
is not always the case).</p></li>
</ul>
<p>Because R doesn’t constrain the potential scope of functions and scripts, <em>you</em> have to. By avoiding these actions, you will create code that is less surprising to other R users. At first, this might seem like tedious busywork. You might find that spooky action is convenient in the moment, and you might convince yourself that it’s necessary or a good idea. But as you share your code with more people and run more code that has been shared with you<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Spooky actions tend to be particularly frustrating to those who teach R, because they have to run scripts from many students, and those scripts can end up doing wacky things to their computers.&lt;/p&gt;"><sup>5</sup></a>, you’ll find spooky action to get more and more surprising and frustrating.</p>
</div>
<div id="what-precisely-is-a-spooky-action" class="section level2" number="31.2">
<h2>
<span class="header-section-number">31.2</span> What precisely is a spooky action?<a class="anchor" aria-label="anchor" href="#what-precisely-is-a-spooky-action"><i class="fas fa-link"></i></a>
</h2>
<p>We can make the notion of spooky action precise by thinking about trees. Code should only affect the tree beneath where it lives, so any action that reaches up, or across, the tree is a <strong>spooky action</strong>.</p>
<p>There are two important types of trees to consider:</p>
<ul>
<li>
<p><strong>The tree formed by files and directories.</strong>
A script should only read from and write to directories beneath the
directory where it lives. This explains why you shouldn’t install packages
(because the package library usually lives elsewhere), and also explains
why you shouldn’t create files on the desktop.</p>
<p>This rule can be relaxed in two small ways. Firstly, if the script
lives in a project, it’s ok to read from and write to anywhere in the
project (i.e. a file in <code>R/</code> can read from <code>data-raw/</code> and write to
<code>data/</code>). Secondly, it’s always ok to write to the session specific
temporary directory, <code><a href="https://rdrr.io/r/base/tempfile.html">tempdir()</a></code>. This directory is automatically deleted
when R closes, so does not have any lasting effects.</p>
</li>
<li><p><strong>The tree of environments created by function calls.</strong>
A function should only create and modify variables in its own environment
or environments that it creates (typically by calling other functions).
This explains why you shouldn’t attach packages (because that changes the
<a href="https://adv-r.hadley.nz/environments.html#search-path">search path</a>),
why you shouldn’t delete variables with <code>rm(list = ls())</code>,
or assign to variables that you didn’t create with <code>&lt;&lt;-</code>.</p></li>
</ul>
</div>
<div id="how-can-i-remediate-spooky-actions" class="section level2" number="31.3">
<h2>
<span class="header-section-number">31.3</span> How can I remediate spooky actions?<a class="anchor" aria-label="anchor" href="#how-can-i-remediate-spooky-actions"><i class="fas fa-link"></i></a>
</h2>
<p>If you have read the above cautions, and still want to proceed, there are three ways you can make the spooky action as safe as possible:</p>
<ul>
<li><p>Allow the user to control the scope.</p></li>
<li><p>Make the action less spooky by giving it a name that clearly describes
what it will do.</p></li>
<li><p>Explicitly check with the user before proceeding with the action.</p></li>
<li><p>Advertise what’s happening, so while the action might still be spooky,
at least it isn’t surprising.</p></li>
</ul>
<div id="parameterise-the-action" class="section level3" number="31.3.1">
<h3>
<span class="header-section-number">31.3.1</span> Parameterise the action<a class="anchor" aria-label="anchor" href="#parameterise-the-action"><i class="fas fa-link"></i></a>
</h3>
<p>The first technique is to allow the user to control where the action will occur. For example, instead of <code>save_output_desktop()</code>, you would write <code>save_output(path)</code>, and require that the user provide the path.</p>
</div>
<div id="advertise-the-action-with-a-clear-name" class="section level3" number="31.3.2">
<h3>
<span class="header-section-number">31.3.2</span> Advertise the action with a clear name<a class="anchor" aria-label="anchor" href="#advertise-the-action-with-a-clear-name"><i class="fas fa-link"></i></a>
</h3>
<p>If you can’t parameterise the action, make it clear what’s going to happen from the outside. It is fine for function or scripts to have actions outside of their usual trees as long as it is implicit in the name:</p>
<ul>
<li><p>It’s ok for <code>&lt;-</code> to modify the global environment, because that is its one
job, and it’s obvious from the name (once you’ve learned about <code>&lt;-</code>, which
happens very early). Similarly, it’s ok for <code>save_output_to_desktop()</code> to
create files in on the desktop, or <code>copy_to_clipboard()</code> to copy text to
the clipboard, because the action is clear from the name.</p></li>
<li><p>It’s fine for <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code> to modify files outside of the current
working directory because it’s designed specifically to install packages.
Similarly, it’s ok for <code>source("class-setup.R")</code> to install packages because
the intent of a setup script is to get your computer into the same state as
someone else’s.</p></li>
</ul>
<p>Here, it’s the name of the function or script that is really important. As soon as you</p>
<p>Note that it’s the name that’s important - it’s fine for <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code> to install packages, but it’s not ok as soon as it’s hidden behind even a very simple wrapper:</p>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">current_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"lubridate"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"lubridate"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/now.html">now</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">current_time</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2022-11-01 04:57:42 UTC"</span></span></code></pre></div>
</div>
<div id="ask-for-confirmation" class="section level3" number="31.3.3">
<h3>
<span class="header-section-number">31.3.3</span> Ask for confirmation<a class="anchor" aria-label="anchor" href="#ask-for-confirmation"><i class="fas fa-link"></i></a>
</h3>
<p>If you can’t parameterise the operation, and need to perform it from somewhere deep within the cope, make sure to confirm with the user before performing the action. The code below shows how you might do so when installing a package:</p>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">install_if_needed</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">package</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="va">package</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html">interactive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="va">package</span>, <span class="st">" is not installed"</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">title</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">package</span>, <span class="st">" is not installed. Do you wish to install now?"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/menu.html">menu</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Yes"</span>, <span class="st">"No"</span><span class="op">)</span>, title <span class="op">=</span> <span class="va">title</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Confirmation not received"</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note the use of <code><a href="https://rdrr.io/r/base/interactive.html">interactive()</a></code> here: if the user is not in an interactive setting (i.e. the code is being run with <code>Rscript</code>) and we can not get explicit confirmation, we shouldn’t make any changes. Also that all failures are errors: this ensures that the remainder of the function or script does not run if the user doesn’t confirm.</p>
<p>Ideally this function would also clearly describe the consequences of your decision. For example, it would be nice to know if it will download a significant amount of data (since you might want to wait until your at a fast connection if downloading a 1 Gb data package), or if it will upgrade existing packages (since that might break other code).</p>
<p>Writing code that checks with the user requires some care, and it’s easy to get the details wrong. That’s why it’s better to prefer one of the prior techniques.</p>
</div>
<div id="advertise-the-side-effects" class="section level3" number="31.3.4">
<h3>
<span class="header-section-number">31.3.4</span> Advertise the side-effects<a class="anchor" aria-label="anchor" href="#advertise-the-side-effects"><i class="fas fa-link"></i></a>
</h3>
<p>If you can’t get explicit confirmation from the user, at the very minimum you should clearly advertise what is happening. For example, when you call <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code> it notifies you:</p>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"dplyr"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Installing package into ‘/Users/hadley/R’</span></span>
<span><span class="co">#&gt; (as ‘lib’ is unspecified)</span></span>
<span><span class="co">#&gt; Trying URL 'https://cran.rstudio.com/bin/macosx/el-capitan/contrib/3.5/dplyr_0.8.0.1.tgz'</span></span>
<span><span class="co">#&gt; Content type 'application/x-gzip' length 6587031 bytes (6.3 MB)</span></span>
<span><span class="co">#&gt; ==================================================</span></span>
<span><span class="co">#&gt; downloaded 6.3 MB</span></span></code></pre></div>
<p>However, this message could do with some work:</p>
<ul>
<li><p>It says installing “package”, without specifying which package (so if
this is called inside another function it won’t be informative).</p></li>
<li><p>It doesn’t notify me which dependencies it’s also going to update.</p></li>
<li><p>It notifies me of the url it’s downloading from, which I don’t care about,
and it only notifies me about the size when it’s finished downloading,
by which time it too late to stop it.</p></li>
</ul>
<p>I would instead write something like this:</p>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"dplyr"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Installing package dplyr to `/Users/hadley/R`</span></span>
<span><span class="co">#&gt; Also installing 3 dependencies: glue, rlang, R6</span></span></code></pre></div>
<p>We’ll come back to the issue of informing the user in …</p>
</div>
</div>
<div id="case-studies" class="section level2" number="31.4">
<h2>
<span class="header-section-number">31.4</span> Case studies<a class="anchor" aria-label="anchor" href="#case-studies"><i class="fas fa-link"></i></a>
</h2>
<div id="save-and-load" class="section level3" number="31.4.1">
<h3>
<span class="header-section-number">31.4.1</span> <code>save()</code> and <code>load()</code><a class="anchor" aria-label="anchor" href="#save-and-load"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/load.html">load()</a></code> has a spooky action because it modifies variables in the current environment:</p>
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"spooky-action.rds"</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; [1] 10</span></span></code></pre></div>
<p>You can make it less spooky by supplying <code>verbose = TRUE</code>. Here we learn that it also loaded a <code>y</code> object:</p>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"spooky-action.rds"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading objects:</span></span>
<span><span class="co">#&gt;   x</span></span>
<span><span class="co">#&gt;   y</span></span>
<span><span class="va">y</span></span>
<span><span class="co">#&gt; [1] 100</span></span></code></pre></div>
<p>(In an ideal world <code>verbose = TRUE</code> would be default)</p>
<p>But generally, I’d avoid <code><a href="https://rdrr.io/r/base/save.html">save()</a></code> and <code><a href="https://rdrr.io/r/base/load.html">load()</a></code> altogether, and instead use <code><a href="https://rdrr.io/r/base/readRDS.html">saveRDS()</a></code> and <code><a href="https://rdrr.io/r/base/readRDS.html">readRDS()</a></code>, which read and write individual R objects to individual R files and work with <code>&lt;-</code>. This eliminates all spooky action:</p>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"x.rds"</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"x.rds"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="st">"x.rds"</span><span class="op">)</span></span></code></pre></div>
<p>(readr provides <code><a href="https://readr.tidyverse.org/reference/read_rds.html">readr::read_rds()</a></code> and <code><a href="https://readr.tidyverse.org/reference/read_rds.html">readr::write_rds()</a></code> if the inconsistent naming conventions bother you like they bother me.)</p>
</div>
<div id="usethis" class="section level3" number="31.4.2">
<h3>
<span class="header-section-number">31.4.2</span> usethis<a class="anchor" aria-label="anchor" href="#usethis"><i class="fas fa-link"></i></a>
</h3>
<p>The usethis package is designed to support the process of developing a package of R code. It automates many of tedious setup steps by providing function like <code>use_r()</code> or <code>use_test()</code>. Many usethis functions modify the <code>DESCRIPTION</code> and create other files. usethis makes these actions as pedestrian as possible by:</p>
<ul>
<li><p>Making it clear that the entire package is designed for the purpose of
creating and modifying files, and the purpose of each function is clearly
encoded in its named.</p></li>
<li>
<p>For any potential risky operation, e.g. overwriting an existing file, usethis
explicitly asks for confirmation from the user. To make it harder to “click”
through prompts without reading them, usethis uses random prompts in a
random ordering.</p>
<div class="sourceCode" id="cb187"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">ui_yeah</span><span class="op">(</span><span class="st">"Do you want to proceed?"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Do you want to proceed?</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 1: Absolutely not</span></span>
<span><span class="co">#&gt; 2: Not now</span></span>
<span><span class="co">#&gt; 3: I agree</span></span></code></pre></div>
<p>usethis also works in concert with git to make sure that change are captured
in a way that can easily be undone.</p>
</li>
<li>
<p>When you call it, every usethis function describes what it is doing as it
it doing it:</p>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">usethis</span><span class="fu">::</span><span class="fu">create_package</span><span class="op">(</span><span class="st">"mypackage"</span>, open <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Creating 'mypackage'</span></span>
<span><span class="co">#&gt; ✔ Setting active project to 'mypackage'</span></span>
<span><span class="co">#&gt; ✔ Creating 'R/'</span></span>
<span><span class="co">#&gt; ✔ Writing 'DESCRIPTION'</span></span>
<span><span class="co">#&gt; ✔ Writing 'NAMESPACE'</span></span>
<span><span class="co">#&gt; ✔ Writing 'mypackage.Rproj'</span></span>
<span><span class="co">#&gt; ✔ Adding '.Rproj.user' to '.gitignore'</span></span>
<span><span class="co">#&gt; ✔ Adding '^mypackage\\.Rproj$', '^\\.Rproj\\.user$' to '.Rbuildignore'</span></span></code></pre></div>
<p>This is important, but it’s not clear how impactful it is because
many functions produce enough output that reading through it all seems
onerous and so generally most people don’t read it.</p>
</li>
</ul>
</div>
<div id="section" class="section level3" number="31.4.3">
<h3>
<span class="header-section-number">31.4.3</span> <code>&lt;&lt;-</code><a class="anchor" aria-label="anchor" href="#section"><i class="fas fa-link"></i></a>
</h3>
<p>If you haven’t heard of <code>&lt;&lt;-</code>, the super-assignment operator, before, feel free to skip this section as it’s an advanced technique that has relatively limited applications. They’re most important in the context of functionals, which you can read more about in <a href="https://adv-r.hadley.nz/function-factories.html#stateful-funs">Advanced R</a>.</p>
<p><code>&lt;&lt;-</code> is safe if you use it to modify a variable in an environment that you control. For example, the following code creates a function that counts the number of times it is called. The use of <code>&lt;&lt;-</code> is safe because it only affects the environment created by <code>make_counter()</code>, not an external environment.</p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_counter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">i</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">c1</span> <span class="op">&lt;-</span> <span class="fu">make_counter</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">c2</span> <span class="op">&lt;-</span> <span class="fu">make_counter</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">c1</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="fu">c1</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="fu">c2</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<p>A more common use of <code>&lt;&lt;-</code> is to break one of the limitations of <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;&lt;code&gt;purrr::map()&lt;/code&gt; is basically interchangeable with &lt;code&gt;base::lapply()&lt;/code&gt; so if you’re more familiar with &lt;code&gt;lapply()&lt;/code&gt;, you can mentally substitute it for &lt;code&gt;map()&lt;/code&gt; in all the code here.&lt;/p&gt;"><sup>6</sup></a> and use it like a for loop to iteratively modify input. For example, imagine you want to compute a cumulative sum. That’s straightforward to write with a for loop:</p>
<div class="sourceCode" id="cb190"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">out</span><span class="op">[[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt;     [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]</span></span>
<span><span class="co">#&gt; x      8    4   11   11   13   15   10   11   11    19</span></span>
<span><span class="co">#&gt; out    8   12   23   34   47   62   72   83   94   113</span></span></code></pre></div>
<p>A simple transformation from to use <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> doesn’t work:</p>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/">purrr</a></span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">out</span><span class="op">[[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]  8  4 11 11 13 15 10 11 11 19</span></span></code></pre></div>
<p>Because the modification of <code>out</code> is happening inside of a function, R creates a copy of <code>out</code> (this is called <a href="https://adv-r.hadley.nz/names-values.html#copy-on-modify">copy-on-modify principle</a>). Instead we need to use <code>&lt;&lt;-</code> to reach outside of the function to modify the outer <code>out</code>:</p>
<div class="sourceCode" id="cb192"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">out</span><span class="op">[[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]   8  12  23  34  47  62  72  83  94 113</span></span></code></pre></div>
<p>This use of <code>&lt;&lt;-</code> is a spooky action because we’re reaching up the tree of environments to modify an object created outside of the function. In this case, however, there’s no point in using <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>: the point of those functions is to restrict what you can do compared to a for loop so that your code is easier to understand. <a href="https://r4ds.had.co.nz/iteration.html#for-loop-variations">R for data science</a> has other examples of for loops that <em>could</em> be rewritten with <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, but shouldn’t be.</p>
<p>Note that we could still wrap this code into a function to eliminate the spooky action:</p>
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cumsum2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">out</span><span class="op">[[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This eliminates the spooky action because it’s now modifying an object that the function “owns”, but I still wouldn’t recommend it, as the use of <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> and <code>&lt;&lt;-</code> only increases complexity for no gain compared to the use of a for loop.</p>
</div>
<div id="assign-in-a-for-loop" class="section level3" number="31.4.4">
<h3>
<span class="header-section-number">31.4.4</span> <code>assign()</code> in a for loop<a class="anchor" aria-label="anchor" href="#assign-in-a-for-loop"><i class="fas fa-link"></i></a>
</h3>
<p>It’s not uncommon for people to ask how to create multiple objects from for a loop. For example, maybe you have a vector of file names, and want to read each file into an individual object. With some effort you typically discover <code><a href="https://rdrr.io/r/base/assign.html">assign()</a></code>:</p>
<div class="sourceCode" id="cb194"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a.csv"</span>, <span class="st">"b.csv"</span>, <span class="st">"c.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">paths</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">paths</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">paths</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="va">paths</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The main problem with this approach is that it does not facilitate composition. For example, imagine that you now wanted to figure out how many rows are in each of the data frames. Now you need to learn how to loop over a series of objects, where the name of the object is stored in a character vector. With some work, you might discover <code><a href="https://rdrr.io/r/base/get.html">get()</a></code> and write:</p>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lengths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">names</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">paths</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lengths</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">paths</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This approach is not necessarily bad in and of itself<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;However, if you take this approach in multiple places in your code, you’ll need to make sure that you don’t use the same name in multiple loops because &lt;code&gt;assign()&lt;/code&gt; will silently overwrite an existing variable. This might not happen commonly but because it’s silent, it will create a bug that is hard to detect.&lt;/p&gt;"><sup>7</sup></a>, but it tends to lead you down a high-friction path. Instead, if you learn a little about lists and functional programming techniques (e.g. with <a href="http://purrr.tidyverse.org/">purrr</a>), you’ll be able to write code like this:</p>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/">purrr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">paths</span>, <span class="va">read.csv</span><span class="op">)</span></span>
<span><span class="va">lengths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_int</a></span><span class="op">(</span><span class="va">files</span>, <span class="va">nrow</span><span class="op">)</span></span></code></pre></div>
<p>This obviously requires that you learn some new tools - but learning about <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> and <code><a href="https://purrr.tidyverse.org/reference/map.html">map_int()</a></code> will pay off in many more situations than learning about <code><a href="https://rdrr.io/r/base/assign.html">assign()</a></code> and <code><a href="https://rdrr.io/r/base/get.html">get()</a></code>. And because you can reuse <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> and friends in many places, you’ll find that they get easier and easier to use over time.</p>
<p>It would certainly be possible to build tools in purrr to avoid having to learn about <code><a href="https://rdrr.io/r/base/assign.html">assign()</a></code> and <code><a href="https://rdrr.io/r/base/get.html">get()</a></code> and to provide a polished interface for working with character vectors containing object names. But such functions would need to reach up the tree of environments, so would violate the “spooky action” principle, and thus I believe are best avoided.</p>

</div>
</div>
</div>




  <div class="chapter-nav">
<div class="prev"><a href="side-effect-soup.html"><span class="header-section-number">30</span> Side-effect soup</a></div>
<div class="next"><a href="glossary.html"><span class="header-section-number">A</span> Glossary</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#spooky-action"><span class="header-section-number">31</span> Spooky action</a></li>
<li><a class="nav-link" href="#whats-the-problem-5"><span class="header-section-number">31.1</span> What’s the problem?</a></li>
<li><a class="nav-link" href="#what-precisely-is-a-spooky-action"><span class="header-section-number">31.2</span> What precisely is a spooky action?</a></li>
<li>
<a class="nav-link" href="#how-can-i-remediate-spooky-actions"><span class="header-section-number">31.3</span> How can I remediate spooky actions?</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#parameterise-the-action"><span class="header-section-number">31.3.1</span> Parameterise the action</a></li>
<li><a class="nav-link" href="#advertise-the-action-with-a-clear-name"><span class="header-section-number">31.3.2</span> Advertise the action with a clear name</a></li>
<li><a class="nav-link" href="#ask-for-confirmation"><span class="header-section-number">31.3.3</span> Ask for confirmation</a></li>
<li><a class="nav-link" href="#advertise-the-side-effects"><span class="header-section-number">31.3.4</span> Advertise the side-effects</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#case-studies"><span class="header-section-number">31.4</span> Case studies</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#save-and-load"><span class="header-section-number">31.4.1</span> save() and load()</a></li>
<li><a class="nav-link" href="#usethis"><span class="header-section-number">31.4.2</span> usethis</a></li>
<li><a class="nav-link" href="#section"><span class="header-section-number">31.4.3</span> &lt;&lt;-</a></li>
<li><a class="nav-link" href="#assign-in-a-for-loop"><span class="header-section-number">31.4.4</span> assign() in a for loop</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="http://github.com/tidyverse/design/blob/main/spooky-action.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="http://github.com/tidyverse/design/edit/main/spooky-action.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Tidyverse design guide</strong>" was written by Tidyverse team. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
